# Malware Playbook

## Scope
This playbook covers the end-to-end response process for malware-related incidents, including initial alert triage, investigation of file and process behavior, containment and remediation actions, and criteria for escalation or closure.

## 1. Preparation

<details>
<summary>Expand/Collapse</summary>

- Create and maintain a list of 
    - All domains owned by the company.
        - This can prevent you from taking actions against company domains.
- Create email template 
    - to contact hosting companies for domain take down
    - to inform 3rd party to take actions against phishing on their infrastructure
- Ensure that:
    - Email security solutions are in place (anti-phishing, anti-malware, quarantine, etc.)
    - Users know how to report phish
    - Detection exists for office documents spawning processes
        - PowerShell
        - CMD
        - WMI
        - MSHTA, etc.
- Perform alert testing to ensure all aspects of the detection and response procedures are working
    - After rule deployment
    - At least once a year
    - Test/Validate: 
        - Customer/Vendor contacts
        - Internal Contact and Escalation Paths
- Review threat intelligence for 
    - Threats to the organization
    - Threats to the sector
    - Common patterns 
    - Newly developing risks and vulnerabilities
- Ensure analysts have access to documentation and information for the following:
    - IR Playbooks/Workflows
    - IR Communication Plan that outlines severity levels and their implications on communications
    - Primary, secondary, and tertiary contacts
    - Communication channels and guidelines
    - Internal communication protocols
    - Defined IR roles and responsibilities

### Tool Access and Provisioning
- Create and maintain a list of
      - Security tools
      - Documentation on logs/fields
### Assets List
- A list of the following should exist and be available for:
    - Customers' Assets
        - Asset owners
        - Contacts
        - Pre-authorized actions
    - Company Assets (Including all subsidiaries)
        - Asset owners
        - Contacts
        - Administrators
        - Pre-autorized actions
- Type of assets inventory needed
    - Endpoints
    - Servers
    - Network Devices
    - Security Tools
    - Network Ranges
        - Public
        - Private
        - VPN / Out of Band
            - Employees
            - Partners
            - Clients

</details>

## 2. Detect
<details open>
<summary>Expand/Collapse</summary>

### Workflow
<details open>
<summary>Expand/Collapse</summary>

![Malware Detection Triage](https://github.com/marthajsosa/IncidentResponsePlaybooks/blob/main/IRP-Malware/Workflows/Malware-Detection-Triage.drawio.png)

</details>

### Identify Threat Indicators
<details open>
<summary>Expand/Collapse</summary>

#### Alerts
Alerts are be generated by differents systems owned by the Security/SOC team. The main sources for alerts are  
- Tickets
- SIEM
- Anti-Virus
- EDR
- Web Proxy
- Email Security
- Cloud-Based Security
- Firewall
- VPN/Remote Access
- Network IDS/IPS
- Analyst initiated
    - Dashboard monitoring, etc.
- IAM

#### Notifications
Notifications are coming from external sources usually via email, Teams or phone. The main sources for notifications are  
- Users (internal)
- Recipents of emails (external)
- Third Parties
- ISP
- Computer Behavior

</details>

### Data Collection
This section describe the information that should be collected and documented about the incident.

<details open>
<summary>Expand/Collapse</summary>

Files 
- Hash
- Reputation
- Publisher/Author
- Behavior

Domains  
- Reputation
- Registrar
- Owner
- IP
- Multistage / Redirect
- IOCs on the site
    - injecting malicious javascript
    - Custom Page (credential phish)

IP  
- Reputation
- Owner
- Geolocation
- Other domains sharing IP

</details>

### Categorize
<details open>
<summary>Expand/Collapse</summary>

Determine type of malware
- Ransomware
- Credential Theft/InfoStealer
- Botnet/Remote Access
- Adware/PUP
- Dropper/Loader
- Fileless Malware

</details>

### Is it a Ransomware?
As time is VERY sensitive in the case of a Ransomware:  
- Follow communication protocol in Incident Response Plan
- Activate the entire SOC team
- Go to the Ransomware Workflow (coming soon).

### Is it an InfoStealer/Credential Harvester?
- Go to the Credential Theft/InfoStealer Workflow (coming soon).

### Is it Botnet/Remote Access activity?
- Go to the Botnet/Remote Access Workflow (coming soon).

### Is it Adware/PUP/Unapproved Software?
- Go to the Unapproved Software Workflow (coming soon).

### Is it a Loader/Dropper?
- Go to the Loader/Dropper Workflow (coming soon).

### Is it Fileless Malware?
- Go to the Fileless Malware Workflow (coming soon).
  
### Triage 
<details open>
<summary>Expand/Collapse</summary>

Determine
- Impact
    - Of destruction caused by malware
    - Lateral movement
    - Financial 
    - Disruption of services, workstations, operations
    - Data loss
    - Data exposure
- Scope: Number and list of hosts that
    - Have malicious files
        - Hash
        - File name
        - RegEx match (ie: INVOICE-12345.docx where `12345` is 5 random digit)
    - Attempted to connect to
        - URLs
        - IP
        - Ports
    - That have persistence mechanisms
    - Any other IOCs found

### Is it a False Positive?

If it's a False Positive:  
- Document and close the incident

If it's a True Positive:  
- Send communication to
    - Security Team
    - Admin Teams
    - Affected asset owners
    - Affected users
    - Managers, etc. according to Incident Response Plan
- Go to Analyze phase

</details>
</details>
</details>

## 3. Analyze
<details open>
<summary>Expand/Collapse</summary>

### Workflow
<details open>
<summary>Expand/Collapse</summary>

![Malware Analysis Workflow](https://github.com/marthajsosa/IncidentResponsePlaybooks/blob/main/IRP-Malware/Workflows/Malware-Analysis-Workflow.drawio.png)

</details>

### Verify
<details open>
<summary>Expand/Collapse</summary>

In conjunction with a senior member of the SOC  
- Double check previous data
- Rule out False Positive

</details>

### Is this a Major/Critical Incident? --> Declare Major Incident
If this incident is deemed **Major or Critical** by the senior analyst follow the Critical Playbook (Coming soon).


### Identify IOCs
<details open>
<summary>Expand/Collapse</summary>

- Validate file hashes
    - [VirusTotal](../Tools/README.md#virus-total)
    - [Hybrid Analysis](Tools/README.md#hybrid-analysis)
- Validate links
    - [VirusTotal](../Tools/README.md#virus-total)
    - [Hybrid Analysis](../Tools/README.md#hybrid-analysis)
    - [URLScan](../Tools/README.md#urlscan)
- ID other addresses, domains, IPs
    - [VirusTotal](../Tools/README.md#virus-total)
    - [Hybrid Analysis](../Tools/README.md#hybrid-analysis)
    - [Talos Intelligence](../Tools/README.md#hybrid-analysis)
    - [Domain Dossier](../Tools/README.md#domain-dossier)
- Search Threat Intel sources
    - [VirusTotal](../Tools/README.md#virus-total)
    - [Hybrid Analysis](../Tools/README.md#hybrid-analysis)
    - [Talos Intelligence](../Tools/README.md#hybrid-analysis)
- Disk forensics on endpoint (if required)

</details>


### Extract IOCs
<details open>
<summary>Expand/Collapse</summary>

#### Sandbox files and urls  
Collect the following informations:  
- Network connections 
- Registry modifications
- Files 
    - dropped
    - accessed
    - modified (renamed)
- Obfuscated/Deobfuscated script
    - From Script Block (for PowerShell)
- New services
    - Created
    - Launched
- New scheduled tasks
- New WMI provider(s)

</details>

### Submit Samples to Partners
<details open>
<summary>Expand/Collapse</summary>

If the malware was not detected/blocked by the security stack  
- Submit Samples to Security Vendor(s)
- Submit URLs, IP, Domains 

</details>

### Scan Enterprise
<details open>
<summary>Expand/Collapse</summary>

- Update AV / EDR 
    - Engine
    - Ruleset 
    - Policies
- Update FW, IDS, etc. rules with IOCs
- Search endpoints for IOCs with EDR
- Search SIEM for IOCs
- Search Firewall, Proxy, DNS logs for IOCs

</details>

### What Was Accessed
<details open>
<summary>Expand/Collapse</summary>

- Look for signs of lateral Movement
- Review firewall logs 
    - Network appliances
    - Endpoint (ie: Windows local firewall, EDR, AV, etc.)
- Review netflows

</details>

### Update Scope
<details open>
<summary>Expand/Collapse</summary>

- Update lists of
    - affected endpoints
    - affected company entities
    - affected clients

</details>

### Scope Validation
<details open>
<summary>Expand/Collapse</summary>

Have all the machines been identified? 
If you find further traces of infection or new IOCs go back to the [Verify Step.](README.md#verify)  (coming soon)

When you are done identifying all compromised:  
- Hosts

And investigated all:  
- URLs
- Domains
- IP
- Ports
- Files
- Hash

</details>

### Do We Need External Help?
<details open>
<summary>Expand/Collapse</summary>

Evaluate if we need 
- Technical, Hands On, Response, etc. support 
- Legal counsel (data breach, lots of clients affected, etc.)

</details>

### Root Cause Analysis
<details open>
<summary>Expand/Collapse</summary>

What was initial access?
- Phish
- Drive by download
- Vulnerability
    - RCE
    - XSS
    - LFI
- Remote services
    - Default / Weak password
    - Brute Force
    - Vulnerability
- USB key/drive

</details>

### Determine Mitre ATT&CK Stage
<details open>
<summary>Expand/Collapse</summary>
The [Mitre ATT&CK Framework]() as various [Tactics] that are part of a [Cyber Kill Chain].  
It is important to know at which stage of the Kill Chain the attack was detected and stopped.  

Document your ticket with the following information:
- Stage of detection
- Stage of prevention
- Was action on objective completed?
    - File encrypted
    - Data exfiltrated
    - Account takeover, etc.
      
If data was exfiltrated go to the [Data Lost Playbook](../IRP-Data_Lost/)  (coming soon)

</details>

### Was Any Data Exfiltrated?
If we know or **suspect** that data was exfiltrated by the adversaries go to [Data Loss Playbook](../IRP-DataLoss/) (coming soon)

### Send communication
<details open>
<summary>Expand/Collapse</summary>

- Send a update communication to managers and teams as outlined in the communication portion of the Incident Response Plan

</details>

Go to the next phase <Contain/Eradicate>
</details>


## 4. Contain / Eradicate
<details open>
<summary>Expand/Collapse</summary>

### Workflow
<details open>
<summary>Expand/Collapse</summary>

![Malware Contain & Eradicate Workflow](https://github.com/marthajsosa/IncidentResponsePlaybooks/blob/main/IRP-Malware/Workflows/Malware-Contain-Eradicate-Workflow.drawio.png)

</details>

### Does the host have EDR?
<details open>
<summary>Expand/Collapse</summary>

If the host **has** an EDR installed go to the [Contain Section](README.md#contain-affected-hosts)  
  
If the host **does not have** an EDR, is it possible to install one?  

Yes: 
- Install EDR
- Go to [Contain section](README.md#contain-affected-hosts)

No: Isolate / Unplug the host
- Apply one of the following containment strategy
    - Remove/shutdown virtual interface
    - Segment into "Dirty" VLAN
    - Shutdown switch port
- Go to [Action Taken section](README.md#action-taken-by-usercomputer)

</details>

### Contain Affected Hosts
<details open>
<summary>Expand/Collapse</summary>

- Update FW, Proxy, etc. rules
- Blackhole DNS
- Submit to Partners
    - AV/EDR Vendor
    - Web Filter Vendor
    - etc.

</details>

### Action Taken by User/Computer
<details open>
<summary>Expand/Collapse</summary>

Did the user: 
- Launch the malware
    - Open document(s)
    - Run the executable
    - Launch the script

Did the computer / EDR:
- Connect to external site(s)
- Write files to disk
- Modified registry keys
- New services
    - Created
    - Launched
- New scheduled tasks
- New WMI provider(s)
- Block excution
- Quarantine file(s)

</details>

### Admin Rights?
<details open>
<summary>Expand/Collapse</summary>

In order to select the right eradication strategy we need to know in which context the malware was executed.  

Was the user admin/root of the machine or any other machines in the environment?  
  
Yes:  
- Wipe physical machine
- Delete virtual machine

No:   
- Delete all IOCs
    - Files
    - Registry keys
    - Services
    - Scheduled Tasks
    - WMI provider(s), etc.

</details>

### Did Vendor Release New Signature?
<details open>
<summary>Expand/Collapse</summary>

Did the security vendor of the AV / EDR released a new engine, signature, policy to address the malware?  
  
No:  
- Go to [Close Monitoring](README.md#close-monitoring)  

Yes:  
- Upgrade security solution
- Update signatures
- Activate policy
- Scan systems enterprise wide 
    - Include customers if required

</details>

### Heightened Monitoring
<details open>
<summary>Expand/Collapse</summary>

- Monitor for: 
    - Internet connections to IOC
    - New files that match hashes identified
    - Processes
    - Behaviors that matched identified TTPs
    
</details>


### All Affected Endpoints Contained?
<details open>
<summary>Expand/Collapse</summary>

If all affected endpoints have been contained, you can go to the <Recover> phase, otherwise continue bellow.  

</details>

### New IOC Discovered?
<details open>
<summary>Expand/Collapse</summary>

If there was new IOC discovered, go back to the [Analyze Phase](README.md#3-analyze)  

Otherwise continue with [host containment](README.md#does-the-host-have-edr)
</details>
</details>

## 5. Recover
<details open>
<summary>Expand/Collapse</summary>

### Workflow
<details open>
<summary>Expand/Collapse</summary>

![Malware Recover Workflow](https://github.com/marthajsosa/IncidentResponsePlaybooks/blob/main/IRP-Malware/Workflows/Malware-Recover-Workflow.drawio.png)

</details>

### Rebuilt Systems
<details open>
<summary>Expand/Collapse</summary>

In an isolated environment:  
    - Install 
        - Supported OS
        - Security solutions
        - Fully patched applications
    - Restore data (from a clean backup)

</details>

### Vulnerability Scan
<details open>
<summary>Expand/Collapse</summary>

Perform:  
- External VA
- If possible
    - Authenticated scan
    - Agent base scan

</details>

### Patch Vulnerabilities
<details open>
<summary>Expand/Collapse</summary>

Any **Critical** or **High** vulnerability needs to be patched **before** the service is reestablish. 
This include, but it not limited to 
- Operating Systems
- Applications
- Network Appliances

Medium and Low vulnerability should be patched if possible, but should not be mandatory for restoring the service/lifting containment. 
</details>

### Update Defenses
<details open>
<summary>Expand/Collapse</summary>

Refine detection rules, note automation opportunities, and/or improve response procedures for the following:
- Firewall Rules
- EDR 
    - Blocked hashes
    - Blocked domains
    - Containment
- Proxy Block
- DNS Sinkhole, etc. 

</details>

### Restore Service
<details open>
<summary>Expand/Collapse</summary>

Depending on the containment applied to the host, perform all the following that applies:  
- Lift containment via EDR
- Move host to production VLAN
- Enable switch port
- Enable/Create virtual network interface
- etc. 

</details>

### All Affected Endpoints Restored?
<details open>
<summary>Expand/Collapse</summary>

If all affected endpoints have been restored, you can go to the <Post Incident> phase, otherwise continue bellow.  
- List systems that haven't been restored
- Go to [README.md#rebuild-systems]

</details>

### Validate Countermeasures
<details open>
<summary>Expand/Collapse</summary>

Determine if legitimate elements are blocked by:  
- AV / EDR
- IPS
- Proxy
- Firewall
- DNS
- Etc.

If so, apply the corrective action to restore functionality  

</details>

### Was Malware Known Before
<details open>
<summary>Expand/Collapse</summary>

If the malware was **not known** before the incident
- Validate with the proper security if you can submit the sample to 3rd parties like
    - VirusTotal
    - Hybrid-Analysis
    - Any.run
    - Threat Grig
    - Google Safe Browsing
    - OpenIOC
    - Industry security organizations (H-ISAC, E-ISAC, Auto-ISAC, etc.)

</details>

</details>

## 6. Post Incident
<details>
<summary>Expand/Collapse</summary>

### Workflow
<details open>
<summary>Expand/Collapse</summary>

![Malware Post-Incident Review](https://github.com/marthajsosa/IncidentResponsePlaybooks/blob/main/IRP-Malware/Workflows/Malware-PostIncident-Review-Workflow.drawio.png)

</details>

### Incident Review
<details open>
<summary>Expand/Collapse</summary>

- What were the strengths? (internally to the overall security posture, detection, response, etc.)
- What were the weaknesses? (internally)
- What opportunities are there? (externally)
- What threats are there? (externally)

</details>

### Update Policies & Procedures
<details open>
<summary>Expand/Collapse</summary>

Update the following documents as required:  
- Policies
- Processes
- Procedures
- Playbooks
- Runbooks
- Automations

Update Detetion Rules in:  
- SIEM
- Malware Gataway
- AV / EDR
- IPS
- Other security tool

</details>

### Review Defensive Posture
<details open>
<summary>Expand/Collapse</summary>

- Schedule review of newly deployed rules in 6 months
- Are the following still applicatble
    - Firewall Rules
    - Proxy Rules for C2
    - AV / EDR custom Signatures
    - IPS Signatures, etc.

</details>

### Update & Upgrade Defenses
<details open>
<summary>Expand/Collapse</summary>

As we still have multiple AV & EDR Vendor, we must ensure **ALL** of them can detect this malware family in the future. Once the AV/EDR vendor confirms they can detect the sample we need to make sure:   
- Anti-Virus 
    - Signatures are updated for all
        - Company entities
        - Customers (globally)
    - Engine upgraded for all
        - Company entities
        - Customers (globally)
- EDR Rules
    - To detect the behaviors of the malware
- Email security tool
- Anti-Spam / Anti-Phish, etc.

</details>


### Build New Detections
<details open>
<summary>Expand/Collapse</summary>

SIEM Rules could be created to catch this type of behaviors and create tickets.

</details>

### Modifify Base Images
<details open>
<summary>Expand/Collapse</summary>

If the Malware Infection was caused by a lack of hardening or insufficient patch level: 
- Review hardening processes
- Include critical patches in base images
- Consider upgrading application
- Apply Security Patch to application, etc.

</details>

### User Awareness Training
<details open>
<summary>Expand/Collapse</summary>

If the incident was caused by a human error:
- Create / Select new mandatory training
    - From Security Education Vendor
    - Built by internal teams

</details>

### Calculate Incident's Cost
<details open>
<summary>Expand/Collapse</summary>


</details>

</details>

# References

This Playbook was built using the following references:  
https://www.dfir.training/index.php?option=com_jreviews&format=ajax&url=media/download&m=14tt1&1600804844570  
https://www.gov.scot/publications/cyber-resilience-incident-management/  
https://github.com/certsocietegenerale/IRM/tree/master/EN  
https://www.incidentresponse.com/playbooks/  
https://ayehu.com/cyber-security-incident-response-automation/top-5-cyber-security-incident-response-playbooks/  
https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-61r2.pdf  
